<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malla Curricular Interactiva üìöüå∏üê±</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #e6d7f2;
      margin: 20px;
      color: #4a3c68;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #5b2e7d;
      font-weight: 700;
      margin-bottom: 30px;
      user-select: none;
    }
    #contenedor {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 20px;
    }
    .semestre {
      background: #f9f2fc;
      border-radius: 16px;
      box-shadow: 0 6px 12px rgba(91, 46, 125, 0.15);
      padding: 20px;
      min-width: 280px;
      flex-shrink: 0;
      position: relative;
      border: 2px solid #c8a4e7;
    }
    .semestre h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.4rem;
      user-select: none;
    }
    .sticker {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.8rem;
      user-select: none;
      pointer-events: none;
      opacity: 0.5;
    }
    .ramo {
      background: #ffffffcc;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin: 10px 0;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s ease, border-left-color 0.3s ease;
      border-left: 8px solid #a1cfff;
      user-select: none;
      cursor: default;
      flex-wrap: wrap;
    }
    .ramo.cursado { opacity: 0.7; border-left-color: #8fc77b; }
    .ramo.reprobado { border-left-color: #f77; opacity: 0.95; }
    .ramo.examen { border-left-color: #f7c677; opacity: 0.85; }
    .ramo.eximido { border-left-color: #8fc77b; opacity: 0.75; }

    label {
      flex: 1;
      padding-right: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      user-select: text;
      min-width: 200px;
    }
    input[type="number"] {
      width: 56px;
      padding: 6px 8px;
      font-size: 1rem;
      border: 2px solid #c8a4e7;
      border-radius: 10px;
      text-align: center;
      transition: border-color 0.3s ease;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: #5b2e7d;
      background-color: #f3e9ff;
    }
    input[disabled] {
      background-color: #eee;
      cursor: not-allowed;
      color: #aaa;
      border-color: #ddd;
    }
    .ramo:not(.bloqueado):hover {
      background-color: #f6e7ff;
      box-shadow: 0 6px 12px rgba(91, 46, 125, 0.3);
    }

    .estado {
      margin-left: 10px;
      font-weight: 700;
      font-size: 0.9rem;
      font-family: monospace;
      user-select: none;
      min-width: 130px;
      text-align: center;
      border-radius: 8px;
      padding: 4px 6px;
      color: white;
      white-space: nowrap;
    }
    .reprobado .estado { background-color: #e04c4c; }
    .examen .estado { background-color: #d6b32b; }
    .eximido .estado { background-color: #3ca34d; }
    .cursado:not(.reprobado):not(.examen):not(.eximido) .estado { background-color: #3ca34d; }

    .mini {
      font-size: 0.75rem;
      font-weight: 700;
      opacity: 0.75;
      user-select: none;
      white-space: nowrap;
    }
    .grupo-examen {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .finalval {
      display: inline-block;
      min-width: 56px;
      text-align: center;
      font-weight: 800;
      font-family: monospace;
      border: 2px dashed #c8a4e7;
      border-radius: 10px;
      padding: 6px 8px;
      background: #ffffffaa;
    }
    .badge {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 800;
      padding: 3px 7px;
      border-radius: 999px;
      border: 2px solid #c8a4e7;
      background: #f3e9ff;
      color: #5b2e7d;
      user-select: none;
    }
  </style>
</head>
<body>
  <h1>üìö Malla Curricular Interactiva üå∏üê±</h1>
  <div id="contenedor"></div>

  <script>
    // ====== REGLAS U ======
    const PESO_PRESENTACION = 0.70;
    const PESO_EXAMEN = 0.30;
    const NOTA_EXIMIDO = 5.0;
    const NOTA_APRUEBA = 4.0;
    const UMBRAL_EXTRA = 3.5;

    const REP_SUFFIX = "__REP"; // clave independiente para el ramo repetido

    const ramos = [
      { nombre: "Introducci√≥n a la contabilidad", semestre: 1, abre: ["Contabilidad financiera"] },
      { nombre: "Normativa empresarial I", semestre: 1, abre: ["Normativa empresarial II"] },
      { nombre: "Gesti√≥n de organizaciones I", semestre: 1, abre: ["Gesti√≥n de organizations II"] },
      { nombre: "Lengua materna y autorregulaci√≥n", semestre: 1 },
      { nombre: "Matem√°ticas I", semestre: 1, abre: ["Matem√°ticas II", "Econom√≠a I"] },

      { nombre: "Contabilidad financiera", semestre: 2, requiere: ["Introducci√≥n a la contabilidad"], abre: ["Normativa contable IFRS"] },
      { nombre: "Normativa empresarial II", semestre: 2, requiere: ["Normativa empresarial I"], abre: ["Normativa tributaria"] },
      { nombre: "Gesti√≥n de organizations II", semestre: 2, requiere: ["Gesti√≥n de organizaciones I"], abre: ["Gesti√≥n de capital humano", "Gesti√≥n comercial"] },
      { nombre: "Introducci√≥n a la auditor√≠a", semestre: 2, abre: ["Control interno y gesti√≥n de riesgos"] },
      { nombre: "Econom√≠a I", semestre: 2, requiere: ["Matem√°ticas I"], abre: ["Econom√≠a II", "Costos para la toma de decisiones I"] },
      { nombre: "Matem√°ticas II", semestre: 2, requiere: ["Matem√°ticas I"], abre: ["Estad√≠stica"] },

      { nombre: "Normativa contable IFRS", semestre: 3, requiere: ["Contabilidad financiera"], abre: ["Normativa contable NIC SP", "Taller de integraci√≥n perfil UV I", "Contabilidad avanzada I", "Proyecto de investigaci√≥n"] },
      { nombre: "Normativa tributaria", semestre: 3, requiere: ["Normativa empresarial II"], abre: ["Impuestos I", "Taller de integraci√≥n perfil UV I"] },
      { nombre: "TIC para los negocios", semestre: 3, abre: ["Taller de integraci√≥n perfil UV I"] },
      { nombre: "Econom√≠a II", semestre: 3, requiere: ["Econom√≠a I"], abre: ["Taller de integraci√≥n perfil UV I"] },
      { nombre: "Estad√≠stica", semestre: 3, requiere: ["Matem√°ticas II"], abre: ["Estad√≠stica para los negocios", "Taller de integraci√≥n perfil UV I"] },
      { nombre: "Control interno y gesti√≥n de riesgos", semestre: 3, requiere: ["Introducci√≥n a la auditor√≠a"], abre: ["Fundamentos de auditor√≠a", "Ejecuci√≥n de proyectos de auditor√≠a", "Auditor√≠a de sistemas", "Proyecto de investigaci√≥n", "Pr√°ctica temprana"] },

      { nombre: "Fundamentos de auditor√≠a", semestre: 4, requiere: ["Control interno y gesti√≥n de riesgos"], abre: ["Taller de integraci√≥n perfil UV I"] },
      { nombre: "Normativa contable NIC SP", semestre: 4, requiere: ["Normativa contable IFRS"], abre: ["Pr√°ctica temprana"] },
      { nombre: "Impuestos I", semestre: 4, requiere: ["Normativa tributaria"], abre: ["Tributaci√≥n aplicada I", "Pr√°ctica temprana"] },
      { nombre: "Costos para la toma de decisiones I", semestre: 4, requiere: ["Econom√≠a I"], abre: ["Pr√°ctica temprana"] },
      { nombre: "Estad√≠stica para los negocios", semestre: 4, requiere: ["Estad√≠stica"], abre: ["Bases y aplicaci√≥n de ciencias de datos", "Costos para la toma de decisiones II"] },
      { nombre: "Ingl√©s I", semestre: 4, abre: ["Ingl√©s II"] },

      { nombre: "Bases y aplicaci√≥n de ciencias de datos", semestre: 5, requiere: ["Estad√≠stica para los negocios"], abre: ["Ejecuci√≥n de proyectos de auditor√≠a"] },
      { nombre: "Tributaci√≥n aplicada I", semestre: 5, requiere: ["Impuestos I"], abre: ["Impuestos II"] },
      { nombre: "Gesti√≥n de capital humano", semestre: 5, requiere: ["Gesti√≥n de organizations II"] },
      { nombre: "Costos para la toma de decisiones II", semestre: 5, requiere: ["Estad√≠stica para los negocios"], abre: ["Introducci√≥n a las finanzas", "Gesti√≥n de operaciones"] },
      { nombre: "Ingl√©s II", semestre: 5, requiere: ["Ingl√©s I"], abre: ["Ingl√©s III"] },
      { nombre: "Taller de integraci√≥n perfil UV I", semestre: 5, requiere: ["Normativa contable IFRS", "Normativa tributaria", "TIC para los negocios", "Econom√≠a II", "Estad√≠stica", "Fundamentos de auditor√≠a"], abre: ["Taller de integraci√≥n perfil UV II"] },

      { nombre: "Contabilidad avanzada I", semestre: 6, requiere: ["Normativa contable IFRS"], abre: ["Contabilidad avanzada II"] },
      { nombre: "Impuestos II", semestre: 6, requiere: ["Tributaci√≥n aplicada I"], abre: ["Tributaci√≥n aplicada II", "Proyecto de investigaci√≥n"] },
      { nombre: "Gesti√≥n comercial", semestre: 6, requiere: ["Gesti√≥n de capital humano"], abre: ["Gesti√≥n de operaciones"] },
      { nombre: "Introducci√≥n a las finanzas", semestre: 6, requiere: ["Costos para la toma de decisiones II"], abre: ["Finanzas corporativas", "Proyecto de investigaci√≥n", "Gesti√≥n financiera"] },
      { nombre: "Ingl√©s III", semestre: 6, requiere: ["Ingl√©s II"], abre: ["Ingl√©s IV"] },
      { nombre: "Taller de integraci√≥n perfil UV II", semestre: 6, requiere: ["Taller de integraci√≥n perfil UV I"] },
      { nombre: "Ejecuci√≥n de proyectos de auditor√≠a", semestre: 6, requiere: ["Bases y aplicaci√≥n de ciencias de datos", "Control interno y gesti√≥n de riesgos"] },

      { nombre: "Contabilidad avanzada II", semestre: 7, requiere: ["Contabilidad avanzada I"], abre: ["Contabilidad avanzada III", "Auditor√≠a de estados financieros", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial", "Pr√°ctica profesional"] },
      { nombre: "Tributaci√≥n aplicada II", semestre: 7, requiere: ["Impuestos II"], abre: ["Gesti√≥n tributaria", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial", "Pr√°ctica profesional"] },
      { nombre: "Gesti√≥n de operaciones", semestre: 7, requiere: ["Gesti√≥n comercial", "Costos para la toma de decisiones II"], abre: ["Planificaci√≥n y control de gesti√≥n", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial"] },
      { nombre: "Auditor√≠a de sistemas", semestre: 7, requiere: ["Control interno y gesti√≥n de riesgos"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial"] },
      { nombre: "Finanzas corporativas", semestre: 7, requiere: ["Introducci√≥n a las finanzas"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Formulaci√≥n y evaluaci√≥n de proyectos de inversi√≥n", "Direcci√≥n gerencial"] },
      { nombre: "Ingl√©s IV", semestre: 7, requiere: ["Ingl√©s III"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial"] },
      { nombre: "Proyecto de investigaci√≥n", semestre: 7, requiere: ["Normativa contable IFRS", "Control interno y gesti√≥n de riesgos", "Impuestos II", "Introducci√≥n a las finanzas"], abre: ["Investigaci√≥n aplicada", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial"] },
      { nombre: "Pr√°ctica temprana", semestre: 7, requiere: ["Normativa contable NIC SP", "Impuestos I", "Costos para la toma de decisiones I", "Control interno y gesti√≥n de riesgos"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "Direcci√≥n gerencial", "Pr√°ctica profesional"] },

      { nombre: "Contabilidad avanzada III", semestre: 8, requiere: ["Contabilidad avanzada II"], abre: ["Taller de integraci√≥n profesional"] },
      { nombre: "Gesti√≥n tributaria", semestre: 8, requiere: ["Tributaci√≥n aplicada II"], abre: ["Taller de integraci√≥n profesional"] },
      { nombre: "Planificaci√≥n y control de gesti√≥n", semestre: 8, requiere: ["Gesti√≥n de operaciones"], abre: ["Taller de integraci√≥n profesional"] },
      { nombre: "Auditor√≠a de estados financieros", semestre: 8, requiere: ["Contabilidad avanzada II"], abre: ["Pr√°ctica profesional", "Taller de integraci√≥n profesional"] },
      { nombre: "Gesti√≥n financiera", semestre: 8, requiere: ["Introducci√≥n a las finanzas"], abre: ["Taller de integraci√≥n profesional"] },
      { nombre: "Investigaci√≥n aplicada", semestre: 8, requiere: ["Proyecto de investigaci√≥n"], abre: ["Taller de integraci√≥n profesional"] },

      { nombre: "Electivo 1 profesional", semestre: 9, requiere: ["Contabilidad avanzada II","Tributaci√≥n aplicada II","Gesti√≥n de operaciones","Auditor√≠a de sistemas","Finanzas corporativas","Ingl√©s IV","Proyecto de investigaci√≥n","Pr√°ctica temprana"] },
      { nombre: "Electivo 2 profesional", semestre: 9, requiere: ["Contabilidad avanzada II","Tributaci√≥n aplicada II","Gesti√≥n de operaciones","Auditor√≠a de sistemas","Finanzas corporativas","Ingl√©s IV","Proyecto de investigaci√≥n","Pr√°ctica temprana"] },
      { nombre: "Electivo 3 profesional", semestre: 9, requiere: ["Contabilidad avanzada II","Tributaci√≥n aplicada II","Gesti√≥n de operaciones","Auditor√≠a de sistemas","Finanzas corporativas","Ingl√©s IV","Proyecto de investigaci√≥n","Pr√°ctica temprana"] },
      { nombre: "Formulaci√≥n y evaluaci√≥n de proyectos de inversi√≥n", semestre: 9, requiere: ["Finanzas corporativas"] },
      { nombre: "Direcci√≥n gerencial", semestre: 9, requiere: ["Contabilidad avanzada II","Tributaci√≥n aplicada II","Gesti√≥n de operaciones","Auditor√≠a de sistemas","Finanzas corporativas","Ingl√©s IV","Proyecto de investigaci√≥n","Pr√°ctica temprana"] },
      { nombre: "Pr√°ctica profesional", semestre: 9, requiere: ["Contabilidad avanzada II","Tributaci√≥n aplicada II","Pr√°ctica temprana","Auditor√≠a de estados financieros"] },

      { nombre: "Taller de integraci√≥n profesional", semestre: 10, requiere: ["Contabilidad avanzada III","Gesti√≥n tributaria","Planificaci√≥n y control de gesti√≥n","Auditor√≠a de estados financieros","Gesti√≥n financiera","Investigaci√≥n aplicada"] }
    ];

    const contenedor = document.getElementById("contenedor");
    let estados = JSON.parse(localStorage.getItem("estadoRamos") || '{}');

    function actualizarLocalStorage() {
      localStorage.setItem("estadoRamos", JSON.stringify(estados));
    }

    function nfloat(x) {
      if (x === "" || x == null) return NaN;
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : NaN;
    }

    function redondear1(n) {
      return Math.round((n + Number.EPSILON) * 10) / 10;
    }

    function keyBase(nombre) { return nombre; }
    function keyRep(nombre) { return nombre + REP_SUFFIX; }

    // Registro (compat con formato antiguo)
    function getRegistro(key) {
      const v = estados[key];
      if (v == null) return { nota: "", ord: "", ext: "" };

      if (typeof v === "object") {
        return { nota: v.nota ?? "", ord: v.ord ?? v.examen ?? "", ext: v.ext ?? "" };
      }
      return { nota: String(v), ord: "", ext: "" };
    }

    function setRegistro(key, patch) {
      const reg = getRegistro(key);
      estados[key] = { ...reg, ...patch };
      actualizarLocalStorage();
      render();
    }

    function finalOrdinaria(reg) {
      const np = nfloat(reg.nota);
      const no = nfloat(reg.ord);
      if (!Number.isFinite(np) || !Number.isFinite(no)) return NaN;
      return redondear1(PESO_PRESENTACION * np + PESO_EXAMEN * no);
    }

    function finalExtra(reg) {
      const np = nfloat(reg.nota);
      const ne = nfloat(reg.ext);
      if (!Number.isFinite(np) || !Number.isFinite(ne)) return NaN;
      return redondear1(PESO_PRESENTACION * np + PESO_EXAMEN * ne);
    }

    // Nota definitiva por "intento" (base o repetido)
    function notaDefinitivaByReg(reg) {
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return NaN;

      if (np >= NOTA_EXIMIDO) return np;

      // con cualquier presentaci√≥n <5, puede ordinario
      const fo = finalOrdinaria(reg);
      if (!Number.isFinite(fo)) return NaN;

      if (fo < UMBRAL_EXTRA) return fo;               // reprobado autom√°tico sin extraordinario
      if (fo >= NOTA_APRUEBA) return fo;              // aprobado con ordinario

      // 3.5 a 3.9 => depende de extraordinario
      const fe = finalExtra(reg);
      if (!Number.isFinite(fe)) return NaN;
      return fe;
    }

    function puedeRendirExtra(reg) {
      const fo = finalOrdinaria(reg);
      return Number.isFinite(fo) && fo >= UMBRAL_EXTRA;
    }

    // Nota definitiva del ramo considerando repetici√≥n independiente:
    // - Si el repetido est√° aprobado definitivo => ese manda (porque es el √∫ltimo)
    // - Si no, si el base est√° aprobado definitivo => ese manda
    // - Si no, si alguno tiene definitivo <4 => reprobado (sigue sin aprobar)
    // - Si no hay definitivo a√∫n => NaN
    function notaDefinitivaRamo(nombre) {
      const regB = getRegistro(keyBase(nombre));
      const regR = getRegistro(keyRep(nombre));

      const ndB = notaDefinitivaByReg(regB);
      const ndR = notaDefinitivaByReg(regR);

      if (Number.isFinite(ndR) && ndR >= NOTA_APRUEBA) return ndR;
      if (Number.isFinite(ndB) && ndB >= NOTA_APRUEBA) return ndB;

      if (Number.isFinite(ndR) && ndR < NOTA_APRUEBA) return ndR;
      if (Number.isFinite(ndB) && ndB < NOTA_APRUEBA) return ndB;

      return NaN;
    }

    function baseReprobadoDefinitivo(nombre) {
      const ndB = notaDefinitivaByReg(getRegistro(keyBase(nombre)));
      return Number.isFinite(ndB) && ndB < NOTA_APRUEBA;
    }

    function repAprobadoDefinitivo(nombre) {
      const ndR = notaDefinitivaByReg(getRegistro(keyRep(nombre)));
      return Number.isFinite(ndR) && ndR >= NOTA_APRUEBA;
    }

    // Necesita mostrar el repetido SOLO cuando el base reprob√≥ definitivo y el repetido a√∫n no aprueba
    function necesitaRepetir(nombre) {
      return baseReprobadoDefinitivo(nombre) && !repAprobadoDefinitivo(nombre);
    }

    // Requisitos se cumplen si el ramo requisito tiene definitiva >=4 (considerando repetido)
    function cumpleRequisitos(ramo) {
      if (!ramo.requiere || ramo.requiere.length === 0) return true;
      return ramo.requiere.every(req => {
        const nd = notaDefinitivaRamo(req);
        return Number.isFinite(nd) && nd >= NOTA_APRUEBA;
      });
    }

    // Mover dependientes si el prerequisito NO est√° aprobado (definitiva <4)
    function calcularShiftDependientes() {
      const dependientes = {};
      ramos.forEach(r => {
        (r.requiere || []).forEach(req => {
          if (!dependientes[req]) dependientes[req] = [];
          dependientes[req].push(r.nombre);
        });
      });

      const shift = {};
      ramos.forEach(r => shift[r.nombre] = 0);

      function propagar(nombre, delta) {
        (dependientes[nombre] || []).forEach(h => {
          if (shift[h] < delta) shift[h] = delta;
          propagar(h, delta);
        });
      }

      ramos.forEach(r => {
        // Si el ramo a√∫n NO est√° aprobado definitivamente, sus dependientes se posponen
        const nd = notaDefinitivaRamo(r.nombre);
        if (Number.isFinite(nd) && nd < NOTA_APRUEBA) {
          propagar(r.nombre, 1);
        }
      });

      return shift;
    }

    function semestreEfectivo(ramo, shiftMap) {
      return (ramo.semestre || 1) + (shiftMap[ramo.nombre] || 0);
    }

    function maxSemestreRender(shiftMap) {
      let m = 10;
      ramos.forEach(r => {
        const base = semestreEfectivo(r, shiftMap);
        m = Math.max(m, base);
        // si necesita repetir, aparece adem√°s en base+1
        if (necesitaRepetir(r.nombre)) m = Math.max(m, base + 1);
      });
      return m;
    }

    // Estado texto y clases por "instancia" (base o repetido)
    function textoEstadoInstancia(reg) {
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return "";

      if (np >= NOTA_EXIMIDO) return "Eximido";

      const fo = finalOrdinaria(reg);
      if (!Number.isFinite(fo)) return "Examen Ord.";

      if (fo < UMBRAL_EXTRA) return `Reprobado (<${UMBRAL_EXTRA})`;
      if (fo >= NOTA_APRUEBA) return "Aprobado Ord.";

      const fe = finalExtra(reg);
      if (!Number.isFinite(fe)) return "Examen Ext.";
      return fe >= NOTA_APRUEBA ? "Aprobado Ext." : "Reprobado Ext.";
    }

    function claseInstancia(reg) {
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return "";

      if (np >= NOTA_EXIMIDO) return "eximido";

      const nd = notaDefinitivaByReg(reg);
      if (Number.isFinite(nd) && nd < NOTA_APRUEBA) return "reprobado";

      return "examen"; // con cualquier presentaci√≥n <5 va a ex√°menes
    }

    function renderInstancia({ ramo, semestreActual, esRepetido, habilitado, key }) {
      const div = document.createElement("div");
      div.classList.add("ramo");

      const reg = getRegistro(key);
      const clase = claseInstancia(reg);
      if (clase) div.classList.add(clase);

      if (!habilitado) div.classList.add("bloqueado");

      const nd = notaDefinitivaByReg(reg);
      const np = nfloat(reg.nota);
      if (Number.isFinite(np) && !(Number.isFinite(nd) && nd < NOTA_APRUEBA)) {
        div.classList.add("cursado");
      }

      const label = document.createElement("label");
      label.textContent = ramo.nombre;
      div.appendChild(label);

      if (esRepetido) {
        const b = document.createElement("span");
        b.classList.add("badge");
        b.textContent = "REPETIDO";
        div.appendChild(b);
      }

      // Presentaci√≥n
      const inputP = document.createElement("input");
      inputP.type = "number";
      inputP.min = "1";
      inputP.max = "7";
      inputP.step = "0.1";
      inputP.value = reg.nota;
      inputP.disabled = !habilitado;

      inputP.addEventListener("change", () => {
        const nuevo = inputP.value;
        const n = nfloat(nuevo);
        if (Number.isFinite(n) && n >= NOTA_EXIMIDO) {
          setRegistro(key, { nota: nuevo, ord: "", ext: "" });
        } else {
          setRegistro(key, { nota: nuevo });
        }
      });

      div.appendChild(inputP);

      // Ex√°menes si hay presentaci√≥n y no es eximido
      const tienePres = Number.isFinite(nfloat(reg.nota));
      const esEximido = tienePres && nfloat(reg.nota) >= NOTA_EXIMIDO;

      if (tienePres && !esEximido) {
        const grupo = document.createElement("span");
        grupo.classList.add("grupo-examen");

        const miniO = document.createElement("span");
        miniO.classList.add("mini");
        miniO.textContent = "Ord:";

        const inputOrd = document.createElement("input");
        inputOrd.type = "number";
        inputOrd.min = "1";
        inputOrd.max = "7";
        inputOrd.step = "0.1";
        inputOrd.value = reg.ord;
        inputOrd.disabled = !habilitado;

        inputOrd.addEventListener("change", () => {
          const nuevoOrd = inputOrd.value;
          const temp = { ...getRegistro(key), ord: nuevoOrd };
          const fo = finalOrdinaria(temp);
          if (Number.isFinite(fo) && fo < UMBRAL_EXTRA) {
            setRegistro(key, { ord: nuevoOrd, ext: "" });
          } else {
            setRegistro(key, { ord: nuevoOrd });
          }
        });

        const miniE = document.createElement("span");
        miniE.classList.add("mini");
        miniE.textContent = "Ext:";

        const inputExt = document.createElement("input");
        inputExt.type = "number";
        inputExt.min = "1";
        inputExt.max = "7";
        inputExt.step = "0.1";
        inputExt.value = reg.ext;
        inputExt.disabled = !habilitado;

        inputExt.addEventListener("change", () => {
          setRegistro(key, { ext: inputExt.value });
        });

        // Final (por instancia)
        const miniF = document.createElement("span");
        miniF.classList.add("mini");
        miniF.textContent = "Final:";

        const finalVal = document.createElement("span");
        finalVal.classList.add("finalval");
        const nd2 = notaDefinitivaByReg(reg);
        finalVal.textContent = Number.isFinite(nd2) ? String(nd2).replace(".", ",") : "‚Äî";

        // bloquear ext si no cumple >=3.5
        if (!puedeRendirExtra(reg)) inputExt.disabled = true;

        grupo.appendChild(miniO);
        grupo.appendChild(inputOrd);
        grupo.appendChild(miniE);
        grupo.appendChild(inputExt);
        grupo.appendChild(miniF);
        grupo.appendChild(finalVal);

        div.appendChild(grupo);
      }

      const estadoSpan = document.createElement("span");
      estadoSpan.classList.add("estado");
      estadoSpan.textContent = textoEstadoInstancia(reg);

      // forzar rojo si definitiva reprobada
      if (Number.isFinite(nd) && nd < NOTA_APRUEBA) {
        div.classList.remove("eximido");
        div.classList.remove("examen");
        div.classList.add("reprobado");
      }

      div.appendChild(estadoSpan);
      return div;
    }

    function render() {
      contenedor.innerHTML = "";

      const shiftMap = calcularShiftDependientes();
      const maxSem = maxSemestreRender(shiftMap);

      const stickers = ["üê±","üéÄ","üìñ","üê∞","üå∑","üêù","ü™Ñ","üåª","ü¶¶","üçÄ","‚ú®","üåô","üß∏","üçì","üßÅ"];

      for (let s = 1; s <= maxSem; s++) {
        const semestre = document.createElement("div");
        semestre.classList.add("semestre");

        const stickerSpan = document.createElement("span");
        stickerSpan.classList.add("sticker");
        stickerSpan.textContent = stickers[(s - 1) % stickers.length];
        semestre.appendChild(stickerSpan);

        const titulo = document.createElement("h2");
        titulo.textContent = `Semestre ${s}`;
        semestre.appendChild(titulo);

        ramos.forEach(ramo => {
          const semBaseMovido = semestreEfectivo(ramo, shiftMap);

          // 1) instancia BASE se muestra cuando coincide con su semestre movido
          if (semBaseMovido === s) {
            const habilitado = cumpleRequisitos(ramo);
            semestre.appendChild(renderInstancia({
              ramo,
              semestreActual: s,
              esRepetido: false,
              habilitado,
              key: keyBase(ramo.nombre)
            }));
          }

          // 2) instancia REPETIDO se muestra SOLO si el base reprob√≥ definitivo y a√∫n no aprueba repetido
          if (necesitaRepetir(ramo.nombre) && (semBaseMovido + 1) === s) {
            // El repetido se habilita igual que el ramo (requisitos), pero normalmente ya los ten√≠a cumplidos cuando lo curs√≥
            const habilitado = true; // para no bloquearte el recursado por reglas viejas
            semestre.appendChild(renderInstancia({
              ramo,
              semestreActual: s,
              esRepetido: true,
              habilitado,
              key: keyRep(ramo.nombre)
            }));
          }
        });

        contenedor.appendChild(semestre);
      }
    }

    render();
  </script>
</body>
</html>
