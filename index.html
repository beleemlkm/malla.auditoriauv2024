<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malla Curricular Interactiva ğŸ“šğŸŒ¸ğŸ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #e6d7f2;
      margin: 20px;
      color: #4a3c68;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #5b2e7d;
      font-weight: 700;
      margin-bottom: 30px;
      user-select: none;
    }
    #contenedor {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 20px;
    }
    .semestre {
      background: #f9f2fc;
      border-radius: 16px;
      box-shadow: 0 6px 12px rgba(91, 46, 125, 0.15);
      padding: 20px;
      min-width: 280px;
      flex-shrink: 0;
      position: relative;
      border: 2px solid #c8a4e7;
    }
    .semestre h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.4rem;
      user-select: none;
    }
    .sticker {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.8rem;
      user-select: none;
      pointer-events: none;
      opacity: 0.5;
    }
    .ramo {
      background: #ffffffcc;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin: 10px 0;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s ease, border-left-color 0.3s ease;
      border-left: 8px solid #a1cfff;
      user-select: none;
      cursor: default;
      flex-wrap: wrap;
    }
    .ramo.cursado { opacity: 0.7; border-left-color: #8fc77b; }
    .ramo.reprobado { border-left-color: #f77; opacity: 0.95; }
    .ramo.examen { border-left-color: #f7c677; opacity: 0.85; }
    .ramo.eximido { border-left-color: #8fc77b; opacity: 0.75; }

    label {
      flex: 1;
      padding-right: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      user-select: text;
      min-width: 200px;
    }
    input[type="number"] {
      width: 56px;
      padding: 6px 8px;
      font-size: 1rem;
      border: 2px solid #c8a4e7;
      border-radius: 10px;
      text-align: center;
      transition: border-color 0.3s ease;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: #5b2e7d;
      background-color: #f3e9ff;
    }
    input[disabled] {
      background-color: #eee;
      cursor: not-allowed;
      color: #aaa;
      border-color: #ddd;
    }

    .ramo:not(.bloqueado):hover {
      background-color: #f6e7ff;
      box-shadow: 0 6px 12px rgba(91, 46, 125, 0.3);
    }

    .estado {
      margin-left: 10px;
      font-weight: 700;
      font-size: 0.9rem;
      font-family: monospace;
      user-select: none;
      min-width: 130px;
      text-align: center;
      border-radius: 8px;
      padding: 4px 6px;
      color: white;
      white-space: nowrap;
    }
    .reprobado .estado { background-color: #e04c4c; }
    .examen .estado { background-color: #d6b32b; }
    .eximido .estado { background-color: #3ca34d; }
    .cursado:not(.reprobado):not(.examen):not(.eximido) .estado { background-color: #3ca34d; }

    .mini {
      font-size: 0.75rem;
      font-weight: 700;
      opacity: 0.75;
      user-select: none;
      white-space: nowrap;
    }
    .grupo-examen {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .finalval {
      display: inline-block;
      min-width: 56px;
      text-align: center;
      font-weight: 800;
      font-family: monospace;
      border: 2px dashed #c8a4e7;
      border-radius: 10px;
      padding: 6px 8px;
      background: #ffffffaa;
    }
    .badge {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 800;
      padding: 3px 7px;
      border-radius: 999px;
      border: 2px solid #c8a4e7;
      background: #f3e9ff;
      color: #5b2e7d;
      user-select: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š Malla Curricular Interactiva ğŸŒ¸ğŸ±</h1>
  <div id="contenedor"></div>

  <script>
    // ====== REGLAS U ======
    const PESO_PRESENTACION = 0.70;
    const PESO_EXAMEN = 0.30;
    const NOTA_EXIMIDO = 5.0;
    const NOTA_APRUEBA = 4.0;
    const UMBRAL_EXTRA = 3.5; // si la ordinaria (0.7P + 0.3Ord) >= 3.5 => puede dar extraordinario

    const ramos = [
      { nombre: "IntroducciÃ³n a la contabilidad", semestre: 1, abre: ["Contabilidad financiera"] },
      { nombre: "Normativa empresarial I", semestre: 1, abre: ["Normativa empresarial II"] },
      { nombre: "GestiÃ³n de organizaciones I", semestre: 1, abre: ["GestiÃ³n de organizaciones II"] },
      { nombre: "Lengua materna y autorregulaciÃ³n", semestre: 1 },
      { nombre: "MatemÃ¡ticas I", semestre: 1, abre: ["MatemÃ¡ticas II", "EconomÃ­a I"] },

      { nombre: "Contabilidad financiera", semestre: 2, requiere: ["IntroducciÃ³n a la contabilidad"], abre: ["Normativa contable IFRS"] },
      { nombre: "Normativa empresarial II", semestre: 2, requiere: ["Normativa empresarial I"], abre: ["Normativa tributaria"] },
      { nombre: "GestiÃ³n de organizaciones II", semestre: 2, requiere: ["GestiÃ³n de organizaciones I"], abre: ["GestiÃ³n de capital humano", "GestiÃ³n comercial"] },
      { nombre: "IntroducciÃ³n a la auditorÃ­a", semestre: 2, abre: ["Control interno y gestiÃ³n de riesgos"] },
      { nombre: "EconomÃ­a I", semestre: 2, requiere: ["MatemÃ¡ticas I"], abre: ["EconomÃ­a II", "Costos para la toma de decisiones I"] },
      { nombre: "MatemÃ¡ticas II", semestre: 2, requiere: ["MatemÃ¡ticas I"], abre: ["EstadÃ­stica"] },

      { nombre: "Normativa contable IFRS", semestre: 3, requiere: ["Contabilidad financiera"], abre: ["Normativa contable NIC SP", "Taller de integraciÃ³n perfil UV I", "Contabilidad avanzada I", "Proyecto de investigaciÃ³n"] },
      { nombre: "Normativa tributaria", semestre: 3, requiere: ["Normativa empresarial II"], abre: ["Impuestos I", "Taller de integraciÃ³n perfil UV I"] },
      { nombre: "TIC para los negocios", semestre: 3, abre: ["Taller de integraciÃ³n perfil UV I"] },
      { nombre: "EconomÃ­a II", semestre: 3, requiere: ["EconomÃ­a I"], abre: ["Taller de integraciÃ³n perfil UV I"] },
      { nombre: "EstadÃ­stica", semestre: 3, requiere: ["MatemÃ¡ticas II"], abre: ["EstadÃ­stica para los negocios", "Taller de integraciÃ³n perfil UV I"] },
      { nombre: "Control interno y gestiÃ³n de riesgos", semestre: 3, requiere: ["IntroducciÃ³n a la auditorÃ­a"], abre: ["Fundamentos de auditorÃ­a", "EjecuciÃ³n de proyectos de auditorÃ­a", "AuditorÃ­a de sistemas", "Proyecto de investigaciÃ³n", "PrÃ¡ctica temprana"] },

      { nombre: "Fundamentos de auditorÃ­a", semestre: 4, requiere: ["Control interno y gestiÃ³n de riesgos"], abre: ["Taller de integraciÃ³n perfil UV I"] },
      { nombre: "Normativa contable NIC SP", semestre: 4, requiere: ["Normativa contable IFRS"], abre: ["PrÃ¡ctica temprana"] },
      { nombre: "Impuestos I", semestre: 4, requiere: ["Normativa tributaria"], abre: ["TributaciÃ³n aplicada I", "PrÃ¡ctica temprana"] },
      { nombre: "Costos para la toma de decisiones I", semestre: 4, requiere: ["EconomÃ­a I"], abre: ["PrÃ¡ctica temprana"] },
      { nombre: "EstadÃ­stica para los negocios", semestre: 4, requiere: ["EstadÃ­stica"], abre: ["Bases y aplicaciÃ³n de ciencias de datos", "Costos para la toma de decisiones II"] },
      { nombre: "InglÃ©s I", semestre: 4, abre: ["InglÃ©s II"] },

      { nombre: "Bases y aplicaciÃ³n de ciencias de datos", semestre: 5, requiere: ["EstadÃ­stica para los negocios"], abre: ["EjecuciÃ³n de proyectos de auditorÃ­a"] },
      { nombre: "TributaciÃ³n aplicada I", semestre: 5, requiere: ["Impuestos I"], abre: ["Impuestos II"] },
      { nombre: "GestiÃ³n de capital humano", semestre: 5, requiere: ["GestiÃ³n de organizations II"] },
      { nombre: "Costos para la toma de decisiones II", semestre: 5, requiere: ["EstadÃ­stica para los negocios"], abre: ["IntroducciÃ³n a las finanzas", "GestiÃ³n de operaciones"] },
      { nombre: "InglÃ©s II", semestre: 5, requiere: ["InglÃ©s I"], abre: ["InglÃ©s III"] },
      { nombre: "Taller de integraciÃ³n perfil UV I", semestre: 5, requiere: ["Normativa contable IFRS", "Normativa tributaria", "TIC para los negocios", "EconomÃ­a II", "EstadÃ­stica", "Fundamentos de auditorÃ­a"], abre: ["Taller de integraciÃ³n perfil UV II"] },

      { nombre: "Contabilidad avanzada I", semestre: 6, requiere: ["Normativa contable IFRS"], abre: ["Contabilidad avanzada II"] },
      { nombre: "Impuestos II", semestre: 6, requiere: ["TributaciÃ³n aplicada I"], abre: ["TributaciÃ³n aplicada II", "Proyecto de investigaciÃ³n"] },
      { nombre: "GestiÃ³n comercial", semestre: 6, requiere: ["GestiÃ³n de organizaciones II"], abre: ["GestiÃ³n de operaciones"] },
      { nombre: "IntroducciÃ³n a las finanzas", semestre: 6, requiere: ["Costos para la toma de decisiones II"], abre: ["Finanzas corporativas", "Proyecto de investigaciÃ³n", "GestiÃ³n financiera"] },
      { nombre: "InglÃ©s III", semestre: 6, requiere: ["InglÃ©s II"], abre: ["InglÃ©s IV"] },
      { nombre: "Taller de integraciÃ³n perfil UV II", semestre: 6, requiere: ["Taller de integraciÃ³n perfil UV I"] },
      { nombre: "EjecuciÃ³n de proyectos de auditorÃ­a", semestre: 6, requiere: ["Bases y aplicaciÃ³n de ciencias de datos", "Control interno y gestiÃ³n de riesgos"] },

      { nombre: "Contabilidad avanzada II", semestre: 7, requiere: ["Contabilidad avanzada I"], abre: ["Contabilidad avanzada III", "AuditorÃ­a de estados financieros", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial", "PrÃ¡ctica profesional"] },
      { nombre: "TributaciÃ³n aplicada II", semestre: 7, requiere: ["Impuestos II"], abre: ["GestiÃ³n tributaria", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial", "PrÃ¡ctica profesional"] },
      { nombre: "GestiÃ³n de operaciones", semestre: 7, requiere: ["GestiÃ³n comercial", "Costos para la toma de decisiones II"], abre: ["PlanificaciÃ³n y control de gestiÃ³n", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial"] },
      { nombre: "AuditorÃ­a de sistemas", semestre: 7, requiere: ["Control interno y gestiÃ³n de riesgos"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial"] },
      { nombre: "Finanzas corporativas", semestre: 7, requiere: ["IntroducciÃ³n a las finanzas"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "FormulaciÃ³n y evaluaciÃ³n de proyectos de inversiÃ³n", "DirecciÃ³n gerencial"] },
      { nombre: "InglÃ©s IV", semestre: 7, requiere: ["InglÃ©s III"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial"] },
      { nombre: "Proyecto de investigaciÃ³n", semestre: 7, requiere: ["Normativa contable IFRS", "Control interno y gestiÃ³n de riesgos", "Impuestos II", "IntroducciÃ³n a las finanzas"], abre: ["InvestigaciÃ³n aplicada", "Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial"] },
      { nombre: "PrÃ¡ctica temprana", semestre: 7, requiere: ["Normativa contable NIC SP", "Impuestos I", "Costos para la toma de decisiones I", "Control interno y gestiÃ³n de riesgos"], abre: ["Electivo 1 profesional", "Electivo 2 profesional", "Electivo 3 profesional", "DirecciÃ³n gerencial", "PrÃ¡ctica profesional"] },

      { nombre: "Contabilidad avanzada III", semestre: 8, requiere: ["Contabilidad avanzada II"], abre: ["Taller de integraciÃ³n profesional"] },
      { nombre: "GestiÃ³n tributaria", semestre: 8, requiere: ["TributaciÃ³n aplicada II"], abre: ["Taller de integraciÃ³n profesional"] },
      { nombre: "PlanificaciÃ³n y control de gestiÃ³n", semestre: 8, requiere: ["GestiÃ³n de operaciones"], abre: ["Taller de integraciÃ³n profesional"] },
      { nombre: "AuditorÃ­a de estados financieros", semestre: 8, requiere: ["Contabilidad avanzada II"], abre: ["PrÃ¡ctica profesional", "Taller de integraciÃ³n profesional"] },
      { nombre: "GestiÃ³n financiera", semestre: 8, requiere: ["IntroducciÃ³n a las finanzas"], abre: ["Taller de integraciÃ³n profesional"] },
      { nombre: "InvestigaciÃ³n aplicada", semestre: 8, requiere: ["Proyecto de investigaciÃ³n"], abre: ["Taller de integraciÃ³n profesional"] },

      { nombre: "Electivo 1 profesional", semestre: 9, requiere: ["Contabilidad avanzada II","TributaciÃ³n aplicada II","GestiÃ³n de operaciones","AuditorÃ­a de sistemas","Finanzas corporativas","InglÃ©s IV","Proyecto de investigaciÃ³n","PrÃ¡ctica temprana"] },
      { nombre: "Electivo 2 profesional", semestre: 9, requiere: ["Contabilidad avanzada II","TributaciÃ³n aplicada II","GestiÃ³n de operaciones","AuditorÃ­a de sistemas","Finanzas corporativas","InglÃ©s IV","Proyecto de investigaciÃ³n","PrÃ¡ctica temprana"] },
      { nombre: "Electivo 3 profesional", semestre: 9, requiere: ["Contabilidad avanzada II","TributaciÃ³n aplicada II","GestiÃ³n de operaciones","AuditorÃ­a de sistemas","Finanzas corporativas","InglÃ©s IV","Proyecto de investigaciÃ³n","PrÃ¡ctica temprana"] },
      { nombre: "FormulaciÃ³n y evaluaciÃ³n de proyectos de inversiÃ³n", semestre: 9, requiere: ["Finanzas corporativas"] },
      { nombre: "DirecciÃ³n gerencial", semestre: 9, requiere: ["Contabilidad avanzada II","TributaciÃ³n aplicada II","GestiÃ³n de operaciones","AuditorÃ­a de sistemas","Finanzas corporativas","InglÃ©s IV","Proyecto de investigaciÃ³n","PrÃ¡ctica temprana"] },
      { nombre: "PrÃ¡ctica profesional", semestre: 9, requiere: ["Contabilidad avanzada II","TributaciÃ³n aplicada II","PrÃ¡ctica temprana","AuditorÃ­a de estados financieros"] },

      { nombre: "Taller de integraciÃ³n profesional", semestre: 10, requiere: ["Contabilidad avanzada III","GestiÃ³n tributaria","PlanificaciÃ³n y control de gestiÃ³n","AuditorÃ­a de estados financieros","GestiÃ³n financiera","InvestigaciÃ³n aplicada"] }
    ];

    const contenedor = document.getElementById("contenedor");
    let estados = JSON.parse(localStorage.getItem("estadoRamos") || '{}');

    function actualizarLocalStorage() {
      localStorage.setItem("estadoRamos", JSON.stringify(estados));
    }

    function nfloat(x) {
      if (x === "" || x == null) return NaN;
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : NaN;
    }

    // redondeo a 1 decimal (3,46 -> 3,5)
    function redondear1(n) {
      return Math.round((n + Number.EPSILON) * 10) / 10;
    }

    // ====== REGISTRO (localStorage) ======
    // formato nuevo: { nota:"", ord:"", ext:"" }
    function getRegistro(nombre) {
      const v = estados[nombre];
      if (v == null) return { nota: "", ord: "", ext: "" };

      if (typeof v === "object") {
        return {
          nota: v.nota ?? "",
          ord: v.ord ?? v.examen ?? "",
          ext: v.ext ?? ""
        };
      }

      return { nota: String(v), ord: "", ext: "" };
    }

    function setRegistro(nombre, patch) {
      const reg = getRegistro(nombre);
      estados[nombre] = { ...reg, ...patch };
      actualizarLocalStorage();
      render();
    }

    // ====== CÃLCULOS ======
    function finalOrdinaria(reg) {
      const np = nfloat(reg.nota);
      const no = nfloat(reg.ord);
      if (!Number.isFinite(np) || !Number.isFinite(no)) return NaN;
      return redondear1(PESO_PRESENTACION * np + PESO_EXAMEN * no);
    }

    function finalExtra(reg) {
      const np = nfloat(reg.nota);
      const ne = nfloat(reg.ext);
      if (!Number.isFinite(np) || !Number.isFinite(ne)) return NaN;
      return redondear1(PESO_PRESENTACION * np + PESO_EXAMEN * ne);
    }

    // Nota definitiva:
    // - si presentaciÃ³n >= 5 => eximido (definitiva = presentaciÃ³n)
    // - si presentaciÃ³n < 5 => requiere ordinario
    //    - si ordinaria < 3.5 => definitiva = ordinaria (reprobado automÃ¡tico)
    //    - si ordinaria >= 3.5:
    //         - si ordinaria >= 4 => definitiva = ordinaria (aprobado)
    //         - si 3.5 <= ordinaria < 4 => requiere extraordinario para definitiva
    function notaDefinitiva(nombre) {
      const reg = getRegistro(nombre);
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return NaN;

      if (np >= NOTA_EXIMIDO) return np;

      const fo = finalOrdinaria(reg);
      if (!Number.isFinite(fo)) return NaN;

      if (fo < UMBRAL_EXTRA) return fo; // reprobado automÃ¡tico sin ext
      if (fo >= NOTA_APRUEBA) return fo; // aprobado con ordinario

      // fo entre 3.5 y 3.9 => depende de extraordinario
      const fe = finalExtra(reg);
      if (!Number.isFinite(fe)) return NaN;
      return fe;
    }

    function puedeRendirExtra(reg) {
      const fo = finalOrdinaria(reg);
      return Number.isFinite(fo) && fo >= UMBRAL_EXTRA;
    }

    function textoEstado(reg) {
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return "";

      if (np >= NOTA_EXIMIDO) return "Eximido";

      // < 5: siempre puede ordinario
      const fo = finalOrdinaria(reg);
      if (!Number.isFinite(fo)) return "Examen Ord.";

      if (fo < UMBRAL_EXTRA) return `Reprobado (<${UMBRAL_EXTRA})`;

      // fo >= 3.5
      if (fo >= NOTA_APRUEBA) return "Aprobado Ord.";

      // 3.5 a 3.9
      const fe = finalExtra(reg);
      if (!Number.isFinite(fe)) return "Examen Ext.";
      if (fe >= NOTA_APRUEBA) return "Aprobado Ext.";
      return "Reprobado Ext.";
    }

    function evaluarClase(reg) {
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return "";

      if (np >= NOTA_EXIMIDO) return "eximido";

      // Si hay definitiva y es <4 => reprobado
      const nd = notaDefinitivaByReg(reg);
      if (Number.isFinite(nd) && nd < NOTA_APRUEBA) return "reprobado";

      // si tiene nota y <5 => examen (aunque sea 3.8)
      return "examen";
    }

    // helper: notaDefinitiva pero usando reg directo (para evitar doble lookup)
    function notaDefinitivaByReg(reg) {
      const np = nfloat(reg.nota);
      if (!Number.isFinite(np)) return NaN;
      if (np >= NOTA_EXIMIDO) return np;

      const fo = finalOrdinaria(reg);
      if (!Number.isFinite(fo)) return NaN;

      if (fo < UMBRAL_EXTRA) return fo;
      if (fo >= NOTA_APRUEBA) return fo;

      const fe = finalExtra(reg);
      if (!Number.isFinite(fe)) return NaN;
      return fe;
    }

    function ramoReprobadoDefinitivo(nombre) {
      const nd = notaDefinitiva(nombre);
      return Number.isFinite(nd) && nd < NOTA_APRUEBA;
    }

    // ====== REQUISITOS ======
    function cumpleRequisitos(ramo) {
      if (!ramo.requiere || ramo.requiere.length === 0) return true;
      return ramo.requiere.every(req => {
        const nd = notaDefinitiva(req);
        return Number.isFinite(nd) && nd >= NOTA_APRUEBA;
      });
    }

    // ====== CADENA: mover dependientes si el prerequisito reprobÃ³ definitivo ======
    function calcularShiftDependientes() {
      const dependientes = {};
      ramos.forEach(r => {
        (r.requiere || []).forEach(req => {
          if (!dependientes[req]) dependientes[req] = [];
          dependientes[req].push(r.nombre);
        });
      });

      const shift = {};
      ramos.forEach(r => shift[r.nombre] = 0);

      function propagar(nombre, delta) {
        (dependientes[nombre] || []).forEach(h => {
          if (shift[h] < delta) shift[h] = delta;
          propagar(h, delta);
        });
      }

      ramos.forEach(r => {
        if (ramoReprobadoDefinitivo(r.nombre)) {
          // OJO: NO movemos el ramo reprobado, movemos los dependientes
          propagar(r.nombre, 1);
        }
      });

      return shift;
    }

    // ====== REPETICIÃ“N: ramo reprobado aparece tambiÃ©n en semestre+1 ======
    function calcularRepites() {
      const repite = {};
      ramos.forEach(r => repite[r.nombre] = false);
      ramos.forEach(r => {
        if (ramoReprobadoDefinitivo(r.nombre)) repite[r.nombre] = true;
      });
      return repite;
    }

    function semestreEfectivo(ramo, shiftMap) {
      return (ramo.semestre || 1) + (shiftMap[ramo.nombre] || 0);
    }

    // Render helper: decide si un ramo debe mostrarse en semestre s
    function seMuestraEnSemestre(ramo, s, shiftMap, repiteMap) {
      const base = semestreEfectivo(ramo, shiftMap);
      if (base === s) return true;

      // si reprobÃ³ definitivo, ademÃ¡s se muestra en el semestre siguiente (del base, no del original)
      // Nota: el ramo en sÃ­ NO se mueve; base ya incluye shift (que para el ramo reprobado serÃ¡ 0).
      if (repiteMap[ramo.nombre] && (base + 1) === s) return true;

      return false;
    }

    function maxSemestreRender(shiftMap, repiteMap) {
      let m = 10;
      ramos.forEach(r => {
        const base = semestreEfectivo(r, shiftMap);
        m = Math.max(m, base);
        if (repiteMap[r.nombre]) m = Math.max(m, base + 1);
      });
      return m;
    }

    // ====== RENDER ======
    function render() {
      contenedor.innerHTML = "";

      const shiftMap = calcularShiftDependientes();
      const repiteMap = calcularRepites();
      const maxSem = maxSemestreRender(shiftMap, repiteMap);

      const stickers = ["ğŸ±","ğŸ€","ğŸ“–","ğŸ°","ğŸŒ·","ğŸ","ğŸª„","ğŸŒ»","ğŸ¦¦","ğŸ€","âœ¨","ğŸŒ™","ğŸ§¸","ğŸ“","ğŸ§"];

      for (let s = 1; s <= maxSem; s++) {
        const semestre = document.createElement("div");
        semestre.classList.add("semestre");

        const stickerSpan = document.createElement("span");
        stickerSpan.classList.add("sticker");
        stickerSpan.textContent = stickers[(s - 1) % stickers.length];
        semestre.appendChild(stickerSpan);

        const titulo = document.createElement("h2");
        titulo.textContent = `Semestre ${s}`;
        semestre.appendChild(titulo);

        ramos
          .filter(r => seMuestraEnSemestre(r, s, shiftMap, repiteMap))
          .forEach(ramo => {
            const div = document.createElement("div");
            div.classList.add("ramo");

            const reg = getRegistro(ramo.nombre);
            const clase = evaluarClase(reg);
            if (clase) div.classList.add(clase);

            // habilitado si cumple requisitos
            // (si estÃ¡ bloqueado, no puedes ingresar notas)
            const habilitado = cumpleRequisitos(ramo);
            if (!habilitado) div.classList.add("bloqueado");

            // cursado si tiene nota y no estÃ¡ reprobado definitivo
            const np = nfloat(reg.nota);
            if (Number.isFinite(np) && !ramoReprobadoDefinitivo(ramo.nombre)) {
              div.classList.add("cursado");
            }

            // etiqueta ramo
            const label = document.createElement("label");
            label.textContent = ramo.nombre;

            // badge "Repite" si es la copia del semestre siguiente
            const baseSem = semestreEfectivo(ramo, shiftMap);
            const esCopiaRepite = repiteMap[ramo.nombre] && (s === baseSem + 1);

            div.appendChild(label);

            if (esCopiaRepite) {
              const b = document.createElement("span");
              b.classList.add("badge");
              b.textContent = "REPETIDO";
              div.appendChild(b);
            }

            // PresentaciÃ³n
            const inputP = document.createElement("input");
            inputP.type = "number";
            inputP.min = "1";
            inputP.max = "7";
            inputP.step = "0.1";
            inputP.value = reg.nota;
            inputP.disabled = !habilitado;

            inputP.addEventListener("change", () => {
              const nuevo = inputP.value;
              const n = nfloat(nuevo);
              // si pasa a eximido, limpiamos exÃ¡menes
              if (Number.isFinite(n) && n >= NOTA_EXIMIDO) {
                setRegistro(ramo.nombre, { nota: nuevo, ord: "", ext: "" });
              } else {
                setRegistro(ramo.nombre, { nota: nuevo });
              }
            });

            div.appendChild(inputP);

            // Si tiene presentaciÃ³n y NO es eximido => inputs de exÃ¡menes
            const tienePresentacion = Number.isFinite(np);
            const esEximido = tienePresentacion && np >= NOTA_EXIMIDO;

            if (tienePresentacion && !esEximido) {
              const grupo = document.createElement("span");
              grupo.classList.add("grupo-examen");

              const miniO = document.createElement("span");
              miniO.classList.add("mini");
              miniO.textContent = "Ord:";

              const inputOrd = document.createElement("input");
              inputOrd.type = "number";
              inputOrd.min = "1";
              inputOrd.max = "7";
              inputOrd.step = "0.1";
              inputOrd.value = reg.ord;
              inputOrd.disabled = !habilitado;

              inputOrd.addEventListener("change", () => {
                // Si ordinaria queda <3.5, extraordinario no aplica: lo limpiamos
                const nuevoOrd = inputOrd.value;
                const temp = { ...getRegistro(ramo.nombre), ord: nuevoOrd };
                const fo = finalOrdinaria(temp);
                if (Number.isFinite(fo) && fo < UMBRAL_EXTRA) {
                  setRegistro(ramo.nombre, { ord: nuevoOrd, ext: "" });
                } else {
                  setRegistro(ramo.nombre, { ord: nuevoOrd });
                }
              });

              const miniE = document.createElement("span");
              miniE.classList.add("mini");
              miniE.textContent = "Ext:";

              const inputExt = document.createElement("input");
              inputExt.type = "number";
              inputExt.min = "1";
              inputExt.max = "7";
              inputExt.step = "0.1";
              inputExt.value = reg.ext;
              inputExt.disabled = !habilitado;

              inputExt.addEventListener("change", () => {
                setRegistro(ramo.nombre, { ext: inputExt.value });
              });

              // Final (definitiva cuando exista; si no, muestra "â€”")
              const miniF = document.createElement("span");
              miniF.classList.add("mini");
              miniF.textContent = "Final:";

              const finalVal = document.createElement("span");
              finalVal.classList.add("finalval");
              const nd = notaDefinitivaByReg(reg);
              finalVal.textContent = Number.isFinite(nd) ? String(nd).replace(".", ",") : "â€”";

              // bloquear ext si no cumple requisito >=3.5
              const puedeExt = puedeRendirExtra(reg);
              if (!puedeExt) {
                inputExt.disabled = true;
              }

              grupo.appendChild(miniO);
              grupo.appendChild(inputOrd);
              grupo.appendChild(miniE);
              grupo.appendChild(inputExt);
              grupo.appendChild(miniF);
              grupo.appendChild(finalVal);

              div.appendChild(grupo);
            }

            // Estado textual
            const estadoSpan = document.createElement("span");
            estadoSpan.classList.add("estado");
            estadoSpan.textContent = textoEstado(reg);

            // si definitivo reprobado => forzar clase reprobado
            if (ramoReprobadoDefinitivo(ramo.nombre)) {
              div.classList.remove("eximido");
              div.classList.remove("examen");
              div.classList.add("reprobado");
            }

            div.appendChild(estadoSpan);
            semestre.appendChild(div);
          });

        contenedor.appendChild(semestre);
      }
    }

    render();
  </script>
</body>
</html>
